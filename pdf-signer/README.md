# PDF Signer

A cross-platform command-line tool for signing PDF files with X.509 certificates (PKCS#12/.p12 format) and adding visible, clickable signature stamps.

## Features

- ✅ Sign PDFs with PKCS#12 (.p12) certificates
- ✅ Add visible signature stamps with custom images
- ✅ Position signatures anywhere on the page
- ✅ Clickable signatures verifiable in Adobe Acrobat and other PDF viewers
- ✅ Optional timestamp support (TSA)
- ✅ PAdES-compliant signatures
- ✅ Cross-platform (macOS, Linux, Windows)
- ✅ Simple CLI interface
- ✅ Signature verification

## Installation

This project uses `uv` for fast Python package management.

### Prerequisites

- Python 3.13+ (or compatible with your system)
- [uv](https://github.com/astral-sh/uv) package manager

### Install

```bash
# Clone or navigate to the project directory
cd pdf-signer

# Install the package with uv
uv pip install -e .

# Or install it directly
uv run pdf-signer --help
```

## Usage

### Basic Signing

Sign a PDF with a PKCS#12 certificate and a visible signature image:

```bash
pdf-signer sign input.pdf output.pdf \
    --p12 certificate.p12 \
    --image signature.png
```

### Sign with Password from File

```bash
pdf-signer sign input.pdf output.pdf \
    --p12 certificate.p12 \
    --password-file password.txt \
    --image signature.png
```

### Custom Position

Place the signature at a specific location:

```bash
pdf-signer sign input.pdf output.pdf \
    --p12 certificate.p12 \
    --image signature.png \
    --position custom \
    --x 100 \
    --y 100 \
    --width 250 \
    --height 120
```

### Predefined Positions

```bash
# Bottom-right (default)
pdf-signer sign input.pdf output.pdf --p12 cert.p12 --image sig.png --position bottom-right

# Top-left
pdf-signer sign input.pdf output.pdf --p12 cert.p12 --image sig.png --position top-left

# Top-right
pdf-signer sign input.pdf output.pdf --p12 cert.p12 --image sig.png --position top-right

# Bottom-left
pdf-signer sign input.pdf output.pdf --p12 cert.p12 --image sig.png --position bottom-left
```

### Sign with Timestamp

Add a trusted timestamp from a TSA server:

```bash
pdf-signer sign input.pdf output.pdf \
    --p12 certificate.p12 \
    --image signature.png \
    --timestamp-url http://timestamp.digicert.com
```

Free TSA servers:

- `http://timestamp.digicert.com`
- `http://timestamp.sectigo.com`
- `http://freetsa.org/tsr`

### Add Metadata

```bash
pdf-signer sign input.pdf output.pdf \
    --p12 certificate.p12 \
    --image signature.png \
    --reason "Contract Approval" \
    --location "Prague, Czech Republic" \
    --contact "admin@example.com"
```

### Invisible Signature

Sign without a visible stamp (useful for document integrity):

```bash
pdf-signer sign input.pdf output.pdf \
    --p12 certificate.p12 \
    --invisible
```

### Verify Signatures

Verify signatures in a signed PDF:

```bash
# Basic verification
pdf-signer verify signed.pdf

# Verbose mode with detailed information
pdf-signer verify signed.pdf --verbose
```

## Creating Demo Files for Testing

Use the included script to create both a sample 3-page PDF document and a professional signature image:

```bash
cd examples
./mk-demo.sh
```

This creates:

- **`demo3page.pdf`** - A 3-page sample contract with:
  - Page 1: Title/Cover page
  - Page 2: Terms and conditions with a table
  - Page 3: Signature page with designated signing areas
- **`signature-demo.png`** - A professional signature image (500x200 pixels) with:
  - Elegant border and styling
  - "Digitally Signed" heading
  - Signer name and date
  - Decorative elements

Both files are created using pure Python (no external tools needed) and work cross-platform.

You can then use these for testing:

```bash
uv run python -m pdf_signer.sign sign examples/demo3page.pdf signed.pdf \
    --p12 certificate.p12 \
    --image examples/signature-demo.png \
    --position bottom-right \
    --page 3
```

## Creating a Signature Image

You can use any image format (PNG, JPG, etc.) for your signature. Here are some tips:

### Recommended Dimensions

- Width: 400-600 pixels
- Height: 200-300 pixels
- Format: PNG with transparency

### Using ImageMagick

Create a simple signature image:

```bash
# Create a transparent background signature
convert -size 500x200 xc:transparent \
    -font Arial -pointsize 24 \
    -fill black \
    -gravity center \
    -annotate +0+0 "Your Name\nYour Title" \
    signature.png
```

### Using GIMP or Photoshop

1. Create a new image with transparent background
2. Add your handwritten signature or text
3. Export as PNG

## Integration with demo-cfssl

Use the S/MIME certificates generated by demo-cfssl:

```bash
# Navigate to demo-cfssl directory
cd ../

# Generate S/MIME certificate if you haven't
./steps.sh

# Sign a PDF with your S/MIME certificate
cd pdf-signer
pdf-signer sign document.pdf signed-document.pdf \
    --p12 ~/.config/demo-cfssl/smime-openssl/john_doe/email.p12 \
    --image signature.png \
    --reason "Document Approval" \
    --location "Prague"
```

## Command Reference

### `pdf-signer sign`

Sign a PDF file.

**Arguments:**

- `input_pdf` - Input PDF file to sign
- `output_pdf` - Output signed PDF file

**Options:**

- `--p12, --pkcs12` - PKCS#12 certificate file (required)
- `--password` - Password for PKCS#12 file
- `--password-file` - File containing password
- `--image` - Signature image file (PNG, JPG, etc.)
- `--page` - Page number for signature (default: 1)
- `--position` - Position: top-left, top-right, bottom-left, bottom-right, custom
- `--x` - X coordinate for custom position (points from left)
- `--y` - Y coordinate for custom position (points from bottom)
- `--width` - Width of signature field (default: 200)
- `--height` - Height of signature field (default: 100)
- `--reason` - Reason for signing (default: "Document Signature")
- `--location` - Location of signing
- `--contact` - Contact information
- `--field-name` - Name of signature field (default: "Signature1")
- `--visible/--invisible` - Visible or invisible signature
- `--timestamp-url` - TSA server URL for timestamp

### `pdf-signer verify`

Verify signatures in a PDF file.

**Arguments:**

- `pdf_file` - PDF file to verify

**Options:**

- `--verbose, -v` - Show detailed verification information

## Technical Details

### PDF Signature Standards

This tool uses **pyHanko** which implements:

- PDF signatures according to ISO 32000-2 (PDF 2.0)
- PAdES (PDF Advanced Electronic Signatures) profiles
- Long-term validation (LTV) support
- Timestamp Protocol (RFC 3161)

### Signature Verification

Signed PDFs can be verified in:

- Adobe Acrobat Reader
- Foxit PDF Reader
- PDF-XChange Editor
- Chrome PDF viewer (basic verification)
- Firefox PDF viewer (basic verification)

### Cross-Platform Compatibility

The tool works on:

- **macOS** - Native support
- **Linux** - Native support
- **Windows** - Native support (via uv/Python)

## Examples

### Example 1: Sign Contract with Company Seal

```bash
pdf-signer sign contract.pdf contract-signed.pdf \
    --p12 company-cert.p12 \
    --password-file .company-pass \
    --image company-seal.png \
    --position bottom-right \
    --width 250 \
    --height 150 \
    --reason "Contract Execution" \
    --location "Company HQ" \
    --timestamp-url http://timestamp.digicert.com
```

### Example 2: Sign Multiple PDFs

```bash
#!/bin/bash
for pdf in documents/*.pdf; do
    output="signed/$(basename "$pdf")"
    pdf-signer sign "$pdf" "$output" \
        --p12 cert.p12 \
        --password-file password.txt \
        --image signature.png \
        --reason "Batch Approval"
    echo "Signed: $output"
done
```

### Example 3: Sign and Verify

```bash
# Sign
pdf-signer sign document.pdf signed.pdf \
    --p12 cert.p12 \
    --image sig.png

# Verify
pdf-signer verify signed.pdf --verbose

# Output example:
# ============================================================
# Signature Field: Signature1
# ============================================================
# Signer: CN=John Doe,O=Company
# Signing time: 2025-10-23 14:30:00
# Valid: True
# Intact: True
# Trust valid: True
```

## Troubleshooting

### "Failed to load PKCS#12 file"

- Check that the password is correct
- Ensure the .p12 file is not corrupted
- Try exporting the certificate again

### "Permission denied"

- Ensure you have write permissions for the output directory
- Check that the output file is not open in another application

### Signature not visible in PDF viewer

- Some PDF viewers may not display the visual signature immediately
- Try zooming in/out or reloading the PDF
- Adobe Acrobat has the best signature display support

### "Module not found"

```bash
# Reinstall dependencies
uv sync
```

## Development

### Running Tests

```bash
uv run pytest
```

### Code Style

```bash
uv run black pdf_signer/
uv run ruff check pdf_signer/
```

## License

This tool is provided as-is for educational and demonstration purposes.

## Credits

Built with:

- [pyHanko](https://github.com/MatthiasValvekens/pyHanko) - PDF signing library
- [Pillow](https://python-pillow.org/) - Image processing
- [Click](https://click.palletsprojects.com/) - CLI framework
- [uv](https://github.com/astral-sh/uv) - Fast Python package manager

## Related Projects

- [demo-cfssl](../) - Certificate authority management with CFSSL
- [CRL Management](../CRL_MANAGEMENT.md) - Certificate revocation

## Support

For issues and questions, refer to the pyHanko documentation:

- https://pyhanko.readthedocs.io/
