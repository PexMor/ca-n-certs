# Traefik TLS/mTLS Demo

This example demonstrates how to use [Traefik](https://traefik.io/) with certificates generated by this CA infrastructure. Traefik is a modern HTTP reverse proxy and load balancer designed for microservices.

## Features

- **Dynamic Configuration**: File-based provider with automatic reload
- **Dual Entry Points**: Separate ports for TLS (8443) and mTLS (8444)
- **Built-in Dashboard**: Web UI for monitoring (port 8080)
- **Modern Architecture**: Cloud-native design
- **TLS Options**: Fine-grained TLS configuration per router
- **Microservices Ready**: Easy integration with Docker, Kubernetes

## Architecture

```
Client
  ↓
[HTTPS Request]
  ↓
Traefik (Container)
  ├─→ EntryPoint: web-tls (8443)
  │   ├─ Router: tls-router
  │   └─ Service: file-server → Nginx backend
  │
  ├─→ EntryPoint: web-mtls (8444)
  │   ├─ Router: mtls-router (with TLS options)
  │   ├─ TLS: RequireAndVerifyClientCert
  │   └─ Service: file-server-mtls → Nginx backend
  │
  └─→ EntryPoint: traefik (8080)
      └─ Dashboard (insecure for demo)

Backend Services:
  ├─ file-server (Nginx) → Serves standard TLS content
  └─ file-server-mtls (Nginx) → Serves mTLS content
```

## Prerequisites

1. **Generated Certificates**:

```bash
cd ../..
./steps.sh step01                                              # Root CA
./steps.sh step02                                              # Intermediate CA
./build_ca_bundle.sh                                          # CA bundle
./steps.sh step03 localhost                                   # Server certificate
./steps.sh step_tls_client "John TLS Client" john@example.com # TLS client certificate
```

2. **Docker and Docker Compose**: Ensure both are installed and running.

## Quick Start

1. **Navigate to the traefik directory**:
```bash
cd more_examples/traefik
```

2. **Start Traefik server**:
```bash
./start.sh
```

3. **Test the endpoints**:
```bash
./curlit.sh
```

4. **View Dashboard** (optional):
```bash
open http://localhost:8080
```

## Manual Testing

### Using curl

**Standard TLS endpoint (port 8443, no client cert required)**:
```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     https://localhost:8443/
```

**mTLS endpoint WITHOUT cert (port 8444, will fail)**:
```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     https://localhost:8444/
# Expected: 400 Bad Request or SSL handshake failure
```

**mTLS endpoint WITH client cert (port 8444)**:
```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     --cert ~/.config/demo-cfssl/tls-clients/john_tls_client/cert.pem \
     --key ~/.config/demo-cfssl/tls-clients/john_tls_client/key.pem \
     https://localhost:8444/
```

## Configuration Details

### Static Configuration (`traefik.yml`)

Defines entry points, providers, and global settings:

```yaml
entryPoints:
  web-tls:
    address: ":8443"
    http:
      tls: {}
  
  web-mtls:
    address: ":8444"
    http:
      tls:
        options: mtls  # References TLS options
```

### Dynamic Configuration (`dynamic.yml`)

Defines routers, services, and TLS settings:

**TLS Options for mTLS**:
```yaml
tls:
  options:
    mtls:
      minVersion: VersionTLS12
      clientAuth:
        caFiles:
          - /ca-bundle.pem
        clientAuthType: RequireAndVerifyClientCert
```

**Router with mTLS**:
```yaml
http:
  routers:
    mtls-router:
      rule: "PathPrefix(`/`)"
      entryPoints:
        - web-mtls
      service: file-server-mtls
      tls:
        options: mtls  # Applies RequireAndVerifyClientCert
```

## Files

- **Dockerfile**: Traefik 3.2 with HTML content
- **traefik.yml**: Static configuration (entry points, providers)
- **dynamic.yml**: Dynamic configuration (routers, services, TLS)
- **docker-compose.yaml**: Multi-container setup (Traefik + 2 Nginx backends)
- **html/**: Content for standard TLS endpoint
- **html-mtls/**: Content for mTLS endpoint
- **start.sh**: Easy startup script
- **curlit.sh**: Automated testing script
- **README.md**: This file

## Traefik vs Other Solutions

| Feature | Traefik | Nginx | APISIX |
|---------|---------|-------|--------|
| **Configuration** | YAML/Labels | Conf files | Admin API |
| **mTLS** | TLS options per router | Per-server | Per-SSL |
| **Dashboard** | Built-in | Third-party | Admin API |
| **Auto-discovery** | Docker/K8s labels | Manual | Service discovery |
| **Performance** | High | Very High | Very High |
| **Best For** | Microservices/K8s | General purpose | API Gateway |
| **Learning Curve** | Medium | Medium | Higher |

## Troubleshooting

### "bad certificate" or connection refused

**Issue**: Client certificate not properly configured or missing.

**Solution**:
1. Verify client certificate has `clientAuth`:
```bash
openssl x509 -in ~/.config/demo-cfssl/tls-clients/john_tls_client/cert.pem \
     -noout -text | grep -A 1 "Extended Key Usage"
```

2. Check Traefik logs:
```bash
docker logs demo-traefik
```

### Dashboard not accessible

**Issue**: Traefik container not running or port conflict.

**Solution**:
```bash
# Check containers
docker compose ps

# Check logs
docker logs demo-traefik

# Restart
docker compose restart traefik
```

### Configuration not reloading

**Issue**: File provider not watching for changes.

**Solution**:
- Check `traefik.yml` has `watch: true` in providers section
- Restart Traefik:
```bash
docker compose restart traefik
```

### Backend service errors

**Issue**: Nginx backend containers not running.

**Solution**:
```bash
# Check all containers
docker compose ps

# Check backend logs
docker logs demo-traefik-files
docker logs demo-traefik-files-mtls

# Restart backends
docker compose restart file-server file-server-mtls
```

## Stopping the Server

```bash
docker compose down
```

To also remove volumes:
```bash
docker compose down -v
```

## Advanced Usage

### Add Custom Router

Edit `dynamic.yml`:

```yaml
http:
  routers:
    api-router:
      rule: "Host(`localhost`) && PathPrefix(`/api`)"
      entryPoints:
        - web-tls
      service: api-backend
  
  services:
    api-backend:
      loadBalancer:
        servers:
          - url: "http://api-server:3000"
```

### Enable Rate Limiting

```yaml
http:
  middlewares:
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
  
  routers:
    tls-router:
      middlewares:
        - rate-limit
```

### Add CORS Support

```yaml
http:
  middlewares:
    cors:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
        accessControlAllowOriginList:
          - "*"
```

### Use with Docker Labels

Instead of file provider, use Docker labels:

```yaml
# docker-compose.yaml
services:
  app:
    image: myapp
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`app.localhost`)"
      - "traefik.http.routers.app.tls=true"
```

## Production Recommendations

1. **Secure Dashboard**:
   - Disable insecure mode
   - Use basicAuth or OAuth middleware
   - Restrict network access

2. **TLS Configuration**:
   - Use TLS 1.3 only in production
   - Configure strong cipher suites
   - Enable HSTS headers

3. **Monitoring**:
   - Enable Prometheus metrics
   - Set up alerting
   - Monitor backend health

4. **High Availability**:
   - Run multiple Traefik instances
   - Use Redis for shared state
   - Load balance across instances

5. **Certificate Management**:
   - Use Let's Encrypt for public certs
   - Implement auto-renewal
   - Monitor certificate expiration

## Integration with Main Project

This example integrates with the main CA project:

1. **Uses existing CA infrastructure**: Root CA, Intermediate CA
2. **Follows same patterns**: Certificate storage in `~/.config/demo-cfssl/`
3. **Compatible with other examples**: Uses same `ca-bundle-myca.pem`
4. **Demonstrates modern proxy**: Cloud-native reverse proxy with mTLS

## Learn More

- [Traefik Documentation](https://doc.traefik.io/traefik/)
- [Traefik TLS Configuration](https://doc.traefik.io/traefik/https/tls/)
- [Traefik Client Authentication](https://doc.traefik.io/traefik/https/tls/#client-authentication-mtls)
- [Main Project Documentation](../../README.md)

## License

Same as main project - see [LICENSE](../../LICENSE)
