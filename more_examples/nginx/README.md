# Nginx TLS/mTLS Demo

This example demonstrates how to use [Nginx](https://nginx.org/) with certificates generated by this CA infrastructure. It showcases both standard TLS and strict mTLS authentication using separate server blocks.

## Features

- **Dual Server Architecture**: Separate ports for TLS and mTLS
- **Port 8443**: Standard TLS (optional client certificate)
- **Port 8444**: Strict mTLS (client certificate REQUIRED)
- **SSI Support**: Server-side includes to display client certificate details
- **Security Headers**: HSTS, X-Frame-Options, X-Content-Type-Options
- **Automated Testing**: `curlit.sh` script for validation

## Key Advantage Over Other Solutions

Unlike Caddy's `mode request` which has limitations in route-level enforcement, Nginx achieves true mTLS enforcement by using separate server blocks. Port 8444 **will reject** connections without a valid client certificate at the TLS handshake level.

## Prerequisites

1. **Generated Certificates**: Run the following to create necessary certificates:

```bash
# Generate CA and ICA (if not already done)
cd ../..
./steps.sh step01  # Root CA
./steps.sh step02  # Intermediate CA

# Build CA bundle (combines Root CA + ICA)
./build_ca_bundle.sh

# Generate server certificate for localhost
./steps.sh step03 localhost

# Generate client certificate (for mTLS endpoint)
# This creates a proper TLS client certificate with clientAuth extended key usage
./steps.sh step_tls_client "John TLS Client" john@example.com
```

2. **Docker and Docker Compose**: Ensure both are installed and running.

## Quick Start

1. **Navigate to the nginx directory**:

```bash
cd more_examples/nginx
```

2. **Start Nginx server**:

```bash
./start.sh
```

3. **Test the endpoints**:

```bash
./curlit.sh
```

## Manual Testing

### Using curl

**Standard TLS endpoint (port 8443, no client cert required)**:

```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     https://localhost:8443/
```

**mTLS endpoint WITHOUT cert (port 8444, will fail)**:

```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     https://localhost:8444/
# Expected: SSL handshake failure or 400 Bad Request
```

**mTLS endpoint WITH client cert (port 8444)**:

```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     --cert ~/.config/demo-cfssl/tls-clients/john_tls_client/cert.pem \
     --key ~/.config/demo-cfssl/tls-clients/john_tls_client/key.pem \
     https://localhost:8444/
```

**Health checks**:

```bash
# Standard TLS
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     https://localhost:8443/health

# mTLS (requires client cert)
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     --cert ~/.config/demo-cfssl/tls-clients/john_tls_client/cert.pem \
     --key ~/.config/demo-cfssl/tls-clients/john_tls_client/key.pem \
     https://localhost:8444/health
```

### Using a Web Browser

1. **Import CA Bundle** into your browser's trust store:

   - **Chrome/Edge**: Settings → Privacy and security → Security → Manage certificates → Authorities → Import `ca-bundle-myca.pem`
   - **Firefox**: Settings → Privacy & Security → Certificates → View Certificates → Authorities → Import `ca-bundle-myca.pem`
   - **Safari**: Open Keychain Access → File → Import Items → Import `ca-bundle-myca.pem`, then trust it

2. **Test standard TLS endpoint**:

   - Navigate to https://localhost:8443/
   - Should work without any client certificate

3. **Test mTLS endpoint**:
   - First, import the client certificate:
     - File: `~/.config/demo-cfssl/tls-clients/john_tls_client/client.p12`
     - Password: (none by default, or whatever you set with TLS_CLIENT_P12_PASSWORD)
   - Navigate to https://localhost:8444/
   - Browser will prompt you to select a client certificate
   - After selecting it, you'll see the success page with certificate details

## Architecture

```
Client
  ↓
[HTTPS Request]
  ↓
Nginx (Container)
  ├─→ Port 8443 (Standard TLS)
  │   ├─ ssl_verify_client: optional
  │   └─ No client cert required
  │
  └─→ Port 8444 (Strict mTLS)
      ├─ ssl_verify_client: on
      └─ Client cert REQUIRED (TLS handshake enforced)
```

## Configuration Details

### nginx.conf Highlights

**Standard TLS Server (Port 8443)**:

```nginx
server {
    listen 8443 ssl http2;
    ssl_certificate /server-certs/bundle-3.pem;
    ssl_certificate_key /server-certs/key.pem;

    # Optional client certificate
    ssl_client_certificate /ca-bundle.pem;
    ssl_verify_client optional;
    ssl_verify_depth 2;
}
```

**mTLS Server (Port 8444)**:

```nginx
server {
    listen 8444 ssl http2;
    ssl_certificate /server-certs/bundle-3.pem;
    ssl_certificate_key /server-certs/key.pem;

    # Client certificate REQUIRED
    ssl_client_certificate /ca-bundle.pem;
    ssl_verify_client on;  # ← Enforces client cert at TLS level
    ssl_verify_depth 2;
}
```

### Client Certificate Variables

Nginx provides these variables when a client certificate is presented:

| Variable              | Description                                        |
| --------------------- | -------------------------------------------------- |
| `$ssl_client_s_dn`    | Subject DN of client certificate                   |
| `$ssl_client_i_dn`    | Issuer DN of client certificate                    |
| `$ssl_client_serial`  | Serial number of client certificate                |
| `$ssl_client_v_start` | Start date of client certificate validity          |
| `$ssl_client_v_end`   | End date of client certificate validity            |
| `$ssl_client_verify`  | Verification result (SUCCESS, FAILED:reason, NONE) |

These are displayed on the mTLS success page using SSI (Server Side Includes).

### Volume Mounts

The `docker-compose.yaml` mounts:

- `~/.config/demo-cfssl/hosts/localhost/` → `/server-certs` (server certificates)
- `~/.config/demo-cfssl/ca-bundle-myca.pem` → `/ca-bundle.pem` (CA bundle for client cert verification)

## Files

- **Dockerfile**: Nginx Alpine image with HTML pages
- **nginx.conf**: Nginx configuration with dual server blocks
- **docker-compose.yaml**: Container orchestration and volume mounts
- **curlit.sh**: Automated testing script
- **start.sh**: Easy startup with prerequisite checking
- **README.md**: This file

## Troubleshooting

### "Connection refused" or "Connection reset"

**Issue**: Docker container not running.

**Solution**:

```bash
docker compose up -d
docker logs demo-nginx
```

### "Certificate verify failed" in curl

**Issue**: CA bundle not trusted or wrong path.

**Solution**:

- Verify CA bundle exists: `ls ~/.config/demo-cfssl/ca-bundle-myca.pem`
- Regenerate if needed: `cd ../.. && ./build_ca_bundle.sh`

### Port 8444 returns "400 Bad Request" or connection fails

**Issue**: This is EXPECTED behavior when no client certificate is provided.

**Solution**:

- This proves mTLS is working correctly!
- Provide a client certificate to access port 8444
- Use the test script: `./curlit.sh`

### "SSL alert number 48" or "tlsv1 alert unknown ca"

**Issue**: Client certificate not signed by trusted CA.

**Solution**:

- Ensure client certificate was generated using the same CA
- Verify CA bundle includes your CA chain
- Check: `openssl verify -CAfile ~/.config/demo-cfssl/ca-bundle-myca.pem ~/.config/demo-cfssl/tls-clients/john_tls_client/cert.pem`

### "unsuitable certificate purpose" - Wrong certificate type

**Issue**: Using an email certificate (from `step_email_openssl`) instead of a TLS client certificate.

**Solution**: Use the proper TLS client certificate function:

```bash
./steps.sh step_tls_client "John TLS Client" john@example.com
```

Email certificates have `extendedKeyUsage = emailProtection`, while TLS client authentication requires `extendedKeyUsage = clientAuth`.

### Browser shows "Your connection is not private"

**Issue**: CA bundle not imported into browser.

**Solution**:

- Import `ca-bundle-myca.pem` into your browser's trust store
- Restart browser after importing

### Browser doesn't prompt for client certificate on port 8444

**Issue**: Client certificate not imported or browser not configured.

**Solution**:

- Import the `.p12` file from `~/.config/demo-cfssl/tls-clients/john_tls_client/`
- Check browser's certificate manager to ensure it's installed
- Ensure you're using a TLS client certificate (not an email certificate)
- Try a different browser (Firefox handles client certs differently than Chrome)

## Stopping the Server

```bash
docker compose down
```

To also remove the built image:

```bash
docker compose down --rmi local
```

## Advanced Usage

### Adding CRL Checking

To enable Certificate Revocation List checking, add to `nginx.conf`:

```nginx
server {
    ...
    ssl_crl /path/to/ica-crl.pem;
}
```

Mount the CRL file in `docker-compose.yaml`:

```yaml
volumes:
  - ${DEMO_CFSSL_DIR}/ica-crl.pem:/crl/ica-crl.pem:ro
```

### Custom Client Certificate Validation

You can use `$ssl_client_verify` to implement custom logic:

```nginx
location /api {
    if ($ssl_client_verify != "SUCCESS") {
        return 403 "Valid client certificate required";
    }
    # Your API logic here
}
```

### Different Ports

Change ports in `docker-compose.yaml`:

```yaml
ports:
  - "9443:8443" # Standard TLS
  - "9444:8444" # mTLS
```

## Comparison with Other Servers

| Feature              | Nginx                  | Caddy                        | APISIX              | Traefik              |
| -------------------- | ---------------------- | ---------------------------- | ------------------- | -------------------- |
| **mTLS Enforcement** | ✅ Perfect (TLS level) | ⚠️ Limited (per-server only) | ✅ Good (per-route) | ✅ Good (per-router) |
| **Configuration**    | Traditional conf files | Simple Caddyfile             | Dynamic API         | Labels/Files         |
| **Performance**      | Very High              | High                         | Very High           | High                 |
| **Maturity**         | Very Mature            | Mature                       | Growing             | Mature               |
| **Best For**         | Production             | Simple setups                | API Gateway         | Kubernetes           |

## Integration with Main Project

This example integrates with the main CA project:

1. **Uses existing CA infrastructure**: Root CA, Intermediate CA
2. **Follows same patterns**: Certificate storage in `~/.config/demo-cfssl/`
3. **Compatible with other examples**: Uses same `ca-bundle-myca.pem`
4. **Demonstrates best practices**: Proper TLS configuration and mTLS enforcement

## Security Notes

⚠️ **This is a demonstration/development setup**. For production:

1. **Use proper secrets management**: Not file-based mounts
2. **Implement certificate rotation**: Automate renewal before expiry
3. **Add CRL/OCSP checking**: Verify certificate revocation status
4. **Use strong TLS settings**: Modern protocols and ciphers only
5. **Enable request limiting**: Prevent DoS attacks
6. **Add monitoring**: Track certificate expiry and mTLS failures
7. **Implement logging**: Audit all authentication attempts
8. **Use WAF**: Add Web Application Firewall for protection

## Production Recommendations

```nginx
# Stronger SSL settings for production
ssl_protocols TLSv1.3;
ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256';
ssl_prefer_server_ciphers on;
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;

# OCSP Stapling
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /path/to/ca-bundle.pem;
resolver 8.8.8.8 8.8.4.4 valid=300s;

# Additional security headers
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
add_header Content-Security-Policy "default-src 'self'" always;
```

## Learn More

- [Nginx SSL Module Documentation](https://nginx.org/en/docs/http/ngx_http_ssl_module.html)
- [Nginx mTLS Configuration Guide](https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_verify_client)
- [Main Project Documentation](../../README.md)
- [Certificate Management Guide](../../docs/certificate-management.md)

## License

Same as main project - see [LICENSE](../../LICENSE)
