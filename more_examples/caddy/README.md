# Caddy Server TLS/mTLS Demo

This example demonstrates how to use [Caddy Server](https://caddyserver.com/) with certificates generated by this CA infrastructure. It showcases both standard TLS and mutual TLS (mTLS) authentication.

## Features

- **Standard TLS Endpoint** (`/`): Basic HTTPS access with server certificate validation
- **mTLS Endpoint** (`/client`): Demonstrates client certificate handling
- **Beautiful HTML Pages**: Modern, styled responses for better demonstration
- **Automated Testing**: `curlit.sh` script for easy testing

### Important Note on mTLS Behavior

This example uses Caddy's `mode request` for client certificates, which **requests** but does not **require** client certificates. This allows having both protected and unprotected endpoints on the same server.

**Limitation**: Route-level client certificate checking with `mode request` is not reliably enforceable in Caddy due to how TLS placeholders are populated.

**For strict mTLS enforcement**, you have two options:

1. **Use `mode require`**: Change `mode request` to `mode require` in the Caddyfile - this will require client certificates for ALL endpoints on the server
2. **Separate server blocks**: Create a dedicated server block (different port or subdomain) with `mode require` for mTLS-only endpoints

This example prioritizes demonstrating both TLS and mTLS concepts on a single server over strict enforcement.

## Prerequisites

1. **Generated Certificates**: Run the following to create necessary certificates:

```bash
# Generate CA and ICA (if not already done)
cd ../..
./steps.sh step01  # Root CA
./steps.sh step02  # Intermediate CA

# Build CA bundle (combines Root CA + ICA)
./build_ca_bundle.sh

# Generate server certificate for localhost
./steps.sh step03 localhost

# Generate client certificate (for mTLS endpoint)
./steps.sh step_email_openssl john_extended john@example.com
```

2. **Docker and Docker Compose**: Ensure both are installed and running.

## Quick Start

1. **Navigate to the caddy directory**:

```bash
cd more_examples/caddy
```

2. **Start Caddy server**:

```bash
docker compose up -d
```

3. **Check logs** (optional):

```bash
docker logs demo-caddy
```

4. **Test the endpoints**:

```bash
./curlit.sh
```

## Manual Testing

### Using curl

**Standard TLS endpoint (no client cert required)**:

```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     https://localhost:8443/
```

**mTLS endpoint (client cert required)**:

```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     --cert ~/.config/demo-cfssl/smime-openssl/john_extended/cert.pem \
     --key ~/.config/demo-cfssl/smime-openssl/john_extended/key.pem \
     https://localhost:8443/client
```

**Health check**:

```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     https://localhost:8443/health
```

### Using a Web Browser

1. **Import CA Bundle** into your browser's trust store:

   - **Chrome/Edge**: Settings → Privacy and security → Security → Manage certificates → Authorities → Import `ca-bundle-myca.pem`
   - **Firefox**: Settings → Privacy & Security → Certificates → View Certificates → Authorities → Import `ca-bundle-myca.pem`
   - **Safari**: Open Keychain Access → File → Import Items → Import `ca-bundle-myca.pem`, then trust it

2. **Navigate to the standard endpoint**:

   - Open https://localhost:8443/ in your browser
   - You should see the welcome page

3. **For the mTLS endpoint** (`/client`):
   - Import the client certificate (PKCS#12 format):
     - File: `~/.config/demo-cfssl/smime-openssl/john_extended/john_extended.p12`
     - Password: (whatever you set during generation, default is usually empty or "changeit")
   - Navigate to https://localhost:8443/client
   - Your browser will prompt you to select a client certificate
   - After selecting it, you should see the success page with your certificate details

## Architecture

```
Browser/Client
     ↓
  [HTTPS Request]
     ↓
Caddy Server (Port 8443)
     ├─→ / (Standard TLS)
     │   └─ Server cert validation only
     │
     ├─→ /client (mTLS)
     │   ├─ Server cert validation
     │   └─ Client cert validation (required)
     │
     └─→ /health (Health check)
```

## Certificate Mapping

| Endpoint  | Server Cert   | Client Cert       | CA Bundle                 |
| --------- | ------------- | ----------------- | ------------------------- |
| `/`       | ✓ (localhost) | ✗ Not required    | ✓ (for server validation) |
| `/client` | ✓ (localhost) | ✓ (john_extended) | ✓ (for both)              |
| `/health` | ✓ (localhost) | ✗ Not required    | ✓ (for server validation) |

## Files

- **Dockerfile**: Caddy server image with configuration
- **Caddyfile**: Caddy server configuration (TLS setup, routes, client auth)
- **docker-compose.yaml**: Container orchestration and volume mounts
- **curlit.sh**: Automated testing script
- **README.md**: This file

## Configuration Details

### Caddyfile Highlights

```caddyfile
https://localhost:8443 {
    # Server certificate
    tls /server-certs/bundle-3.pem /server-certs/key.pem {
        # Client certificate verification
        client_auth {
            mode request
            trusted_ca_cert_file /ca-bundle.pem
        }
    }

    # Routes with conditional client cert checking
    route /client {
        @has_client_cert {
            expression {http.request.tls.client.certificate_pem} != ""
        }
        # ...
    }
}
```

### Volume Mounts

The `docker-compose.yaml` mounts:

- `~/.config/demo-cfssl/hosts/localhost/` → `/server-certs` (server certificates)
- `~/.config/demo-cfssl/ca-bundle-myca.pem` → `/ca-bundle.pem` (CA bundle for client cert verification)

**Note on CA Bundle Files**: The `build_ca_bundle.sh` script creates several CA bundle variants:

- `ca-bundle-myca.pem` - Root CA + ICA only (used for this example)
- `ca-bundle-complete.pem` - Root CA + ICA + System CAs
- `ca-bundle-all-roots.pem` - Root CA + System CAs (no ICA)
- `ca-bundle-system.pem` - System CAs only

For client certificate verification, we use `ca-bundle-myca.pem` since we only need to trust certificates issued by our own CA chain.

## Troubleshooting

### "Connection refused" or "Connection reset"

**Issue**: Docker container not running.

**Solution**:

```bash
docker compose up -d
docker logs demo-caddy
```

### "Certificate verify failed" in curl

**Issue**: CA bundle not trusted or wrong path.

**Solution**:

- Verify CA bundle exists: `ls ~/.config/demo-cfssl/ca-bundle-myca.pem`
- Regenerate if needed: `cd ../.. && ./build_ca_bundle.sh`

### "/client returns 403 Forbidden"

**Issue**: No client certificate provided or invalid certificate.

**Solution**:

- Ensure client certificate exists: `ls ~/.config/demo-cfssl/smime-openssl/john_extended/`
- Regenerate if needed: `./steps.sh step_email_openssl john_extended john@example.com`
- Use `curlit.sh` to test properly

### Browser shows "Your connection is not private"

**Issue**: CA bundle not imported into browser.

**Solution**:

- Import `ca-bundle-myca.pem` into your browser's trust store (see "Using a Web Browser" section above)
- Restart browser after importing

### "Client certificate required" in browser for /client

**Issue**: Client certificate not imported or not selected.

**Solution**:

- Import the `.p12` file from `~/.config/demo-cfssl/smime-openssl/john_extended/`
- When prompted, select the certificate
- Check browser's certificate manager to ensure it's installed

## Stopping the Server

```bash
docker compose down
```

To also remove the built image:

```bash
docker compose down --rmi local
```

## Advanced Usage

### Custom Client Certificates

To create additional client certificates for different users:

```bash
./steps.sh step_email_openssl alice alice@example.com
./steps.sh step_email_openssl bob bob@example.com
```

Then import the respective `.p12` files into browsers or use with curl:

```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     --cert ~/.config/demo-cfssl/smime-openssl/alice/cert.pem \
     --key ~/.config/demo-cfssl/smime-openssl/alice/key.pem \
     https://localhost:8443/client
```

### Modify Caddy Configuration

Edit `Caddyfile` and rebuild:

```bash
docker compose down
docker compose build
docker compose up -d
```

### View Certificate Details in Response

The `/client` endpoint displays certificate information when authentication succeeds:

- Subject
- Issuer
- Serial Number
- Validity Period (Not Before/Not After)

## Integration with Main Project

This example integrates with the main CA project:

1. **Uses existing CA infrastructure**: Root CA, Intermediate CA
2. **Follows same patterns**: Certificate storage in `~/.config/demo-cfssl/`
3. **Compatible with other examples**: Uses same `ca-bundle-myca.pem`
4. **Demonstrates real-world usage**: TLS + mTLS in web server

## Security Notes

⚠️ **This is a demonstration/development setup**. For production:

1. **Use proper certificate management**: Not file-based mounts
2. **Implement certificate rotation**: Automate renewal
3. **Add CRL/OCSP checking**: Verify certificate revocation status
4. **Use secrets management**: Don't mount keys directly
5. **Enable proper logging**: Audit client certificate usage
6. **Restrict client auth**: Implement fine-grained access control

## Learn More

- [Caddy Documentation](https://caddyserver.com/docs/)
- [Caddy TLS Configuration](https://caddyserver.com/docs/caddyfile/directives/tls)
- [Caddy Client Authentication](https://caddyserver.com/docs/json/apps/http/servers/tls_connection_policies/client_authentication/)
- [Main Project Documentation](../../README.md)

## License

Same as main project - see [LICENSE](../../LICENSE)
