# Apache APISIX TLS/mTLS Demo

This example demonstrates how to use [Apache APISIX](https://apisix.apache.org/) with certificates generated by this CA infrastructure. APISIX is a cloud-native API Gateway built on Nginx and OpenResty with dynamic configuration via Admin API.

> **Note**: APISIX's mTLS implementation verifies client certificates when provided but accepts connections without them (similar to Caddy's `mode request`). For stricter enforcement at the TLS handshake level, consider using Nginx or Traefik which reject connections immediately without valid client certificates.

## Features

- **Dynamic Configuration**: Routes configured via Admin API
- **Dual Port Architecture**: Separate ports for TLS (9443) and mTLS (9444)
- **etcd Backend**: Configuration stored in etcd for high availability
- **Plugin System**: Extensible via APISIX plugins
- **Admin API**: RESTful API for runtime configuration
- **Production-Grade**: Built on battle-tested Nginx/OpenResty

## Architecture

```
Client
  ↓
[HTTPS Request]
  ↓
Apache APISIX (Container)
  ├─→ Port 9443 (Standard TLS)
  │   └─ No client cert required
  │
  ├─→ Port 9444 (Strict mTLS)
  │   └─ Client cert REQUIRED
  │
  └─→ Port 9180 (Admin API)
      └─ HTTP only (local access)

etcd (Container)
  └─ Configuration Storage
```

## Prerequisites

1. **Generated Certificates**:

```bash
cd ../..
./steps.sh step01                                              # Root CA
./steps.sh step02                                              # Intermediate CA
./build_ca_bundle.sh                                          # CA bundle
./steps.sh step03 localhost                                   # Server certificate
./steps.sh step_tls_client "John TLS Client" john@example.com # TLS client certificate
```

2. **Docker and Docker Compose**: Ensure both are installed and running.

## Quick Start

1. **Navigate to the apisix directory**:

```bash
cd more_examples/apisix
```

2. **Start APISIX server** (includes etcd):

```bash
./start.sh
```

This will:

- Start etcd container
- Start APISIX container
- Configure routes via Admin API
- Set up TLS and mTLS endpoints

3. **Test the endpoints**:

```bash
./curlit.sh
```

## Manual Testing

### Using curl

**Standard TLS endpoint (port 9443, no client cert required)**:

```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     https://localhost:9443/
```

**mTLS endpoint WITHOUT cert (port 9444, will fail)**:

```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     https://localhost:9444/
# Expected: 400 Bad Request or SSL handshake failure
```

**mTLS endpoint WITH client cert (port 9444)**:

```bash
curl --cacert ~/.config/demo-cfssl/ca-bundle-myca.pem \
     --cert ~/.config/demo-cfssl/tls-clients/john_tls_client/cert.pem \
     --key ~/.config/demo-cfssl/tls-clients/john_tls_client/key.pem \
     https://localhost:9444/
```

**Admin API** (list routes):

```bash
curl -H 'X-API-KEY: admin-key-for-demo' \
     http://localhost:9180/apisix/admin/routes
```

## Configuration Details

### SSL Configuration

**Standard TLS (Port 9443)**:

- Configured via Admin API (`/apisix/admin/ssls/1`)
- Server certificate from `bundle-3.pem`
- No client certificate required

**mTLS (Port 9444)**:

- Configured via Admin API (`/apisix/admin/ssls/2`)
- Server certificate from `bundle-3.pem`
- Client certificate verification enabled:
  ```json
  {
    "client": {
      "ca": "ca-bundle-myca.pem",
      "depth": 2
    }
  }
  ```

### Route Configuration

Routes are created dynamically via the Admin API during startup:

1. **Route 1**: Standard TLS root endpoint
2. **Route 2**: mTLS root endpoint
3. **Route 3**: Standard TLS health check
4. **Route 4**: mTLS health check

See `setup-routes.sh` for full configuration details.

## Files

- **Dockerfile**: APISIX 3.11 on Debian
- **config.yaml**: APISIX static configuration
- **docker-compose.yaml**: Multi-container setup (APISIX + etcd)
- **setup-routes.sh**: Admin API configuration script
- **start.sh**: Easy startup with route configuration
- **curlit.sh**: Automated testing script
- **README.md**: This file

## APISIX vs Other Solutions

| Feature           | APISIX         | Nginx           | Caddy         |
| ----------------- | -------------- | --------------- | ------------- |
| **Configuration** | Dynamic API    | Static files    | Simple files  |
| **mTLS**          | Per-SSL config | Per-server      | Per-server    |
| **Plugins**       | 80+ plugins    | Modules         | Built-in      |
| **Performance**   | Very High      | Very High       | High          |
| **Use Case**      | API Gateway    | General purpose | Simple setups |
| **Complexity**    | Higher (etcd)  | Medium          | Low           |

## Troubleshooting

### "Connection refused" on startup

**Issue**: Services not fully initialized.

**Solution**:

```bash
# Check logs
docker logs demo-apisix
docker logs demo-apisix-etcd

# Restart if needed
docker compose down
./start.sh
```

### Routes not configured

**Issue**: Setup script didn't run or failed.

**Solution**:

```bash
# Manually run setup
docker exec demo-apisix /bin/sh /setup-routes.sh

# Check routes
curl -H 'X-API-KEY: admin-key-for-demo' \
     http://localhost:9180/apisix/admin/routes
```

### mTLS not working

**Issue**: SSL configuration not applied.

**Solution**:

1. Check SSL configurations:

```bash
curl -H 'X-API-KEY: admin-key-for-demo' \
     http://localhost:9180/apisix/admin/ssls
```

2. Verify client certificate has `clientAuth`:

```bash
openssl x509 -in ~/.config/demo-cfssl/tls-clients/john_tls_client/cert.pem \
     -noout -text | grep -A 1 "Extended Key Usage"
```

### etcd connection errors

**Issue**: etcd not healthy or accessible.

**Solution**:

```bash
# Check etcd health
docker exec demo-apisix-etcd etcdctl endpoint health

# Restart etcd
docker compose restart etcd
sleep 5
docker compose restart apisix
```

## Stopping the Server

```bash
docker compose down
```

To also remove volumes:

```bash
docker compose down -v
```

## Advanced Usage

### Add Custom Route

```bash
curl -X PUT http://localhost:9180/apisix/admin/routes/5 \
  -H 'X-API-KEY: admin-key-for-demo' \
  -H 'Content-Type: application/json' \
  -d '{
    "uri": "/api/*",
    "host": "localhost:9443",
    "upstream": {
      "type": "roundrobin",
      "nodes": {
        "backend:8080": 1
      }
    }
  }'
```

### Enable Rate Limiting

```bash
curl -X PUT http://localhost:9180/apisix/admin/routes/1 \
  -H 'X-API-KEY: admin-key-for-demo' \
  -H 'Content-Type: application/json' \
  -d '{
    "uri": "/*",
    "plugins": {
      "limit-req": {
        "rate": 10,
        "burst": 5,
        "key": "remote_addr"
      }
    },
    "upstream": {...}
  }'
```

### Monitor with Prometheus

APISIX exports metrics on port 9091:

```bash
curl http://localhost:9091/apisix/prometheus/metrics
```

## Production Recommendations

1. **Secure Admin API**:

   - Use strong API keys
   - Enable mTLS for Admin API
   - Restrict network access

2. **High Availability**:

   - Run multiple APISIX instances
   - Use etcd cluster (3+ nodes)
   - Add load balancer in front

3. **Monitoring**:

   - Enable Prometheus metrics
   - Set up alerting
   - Monitor etcd health

4. **Configuration Management**:
   - Version control your routes
   - Use declarative configuration files
   - Implement CI/CD for route updates

## Integration with Main Project

This example integrates with the main CA project:

1. **Uses existing CA infrastructure**: Root CA, Intermediate CA
2. **Follows same patterns**: Certificate storage in `~/.config/demo-cfssl/`
3. **Compatible with other examples**: Uses same `ca-bundle-myca.pem`
4. **Demonstrates API Gateway**: Dynamic configuration via REST API

## Learn More

- [APISIX Documentation](https://apisix.apache.org/docs/apisix/getting-started/)
- [APISIX Admin API](https://apisix.apache.org/docs/apisix/admin-api/)
- [APISIX Plugins](https://apisix.apache.org/docs/apisix/plugins/overview/)
- [Main Project Documentation](../../README.md)

## License

Same as main project - see [LICENSE](../../LICENSE)
