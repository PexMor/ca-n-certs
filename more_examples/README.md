# More Examples

This folder contains real-world examples demonstrating how to use certificates generated by this CA infrastructure with popular web servers and reverse proxies.

## Overview

Each example includes:

- ✅ **Complete Docker setup** - Dockerfile and docker-compose.yaml
- ✅ **TLS Configuration** - Server-side HTTPS with custom certificates
- ✅ **mTLS Support** - Client certificate authentication examples
- ✅ **Test Scripts** - Automated `curlit.sh` for validation
- ✅ **Start Script** - Easy `start.sh` with prerequisite checking
- ✅ **Full Documentation** - Comprehensive README with troubleshooting

## Available Examples

### ✅ 1. Caddy Server (Complete)

**Link**: <https://caddyserver.com/>

Modern, automatic HTTPS server written in Go. Features automatic certificate management and easy configuration.

**Status**: ✅ **Fully Implemented**

**Location**: [caddy/](caddy/)

**Endpoints**:

- `https://localhost:8443/` - Standard TLS endpoint
- `https://localhost:8443/client` - Client certificate demonstration
- `https://localhost:8443/health` - Health check

**Quick Start**:

```bash
cd caddy
./start.sh
./curlit.sh
```

**Note**: Demonstrates `mode request` behavior where client certificates are optional.

### ✅ 2. Nginx (Complete)

**Link**: <https://nginx.org/>

High-performance HTTP server and reverse proxy. Industry standard for serving web applications.

**Status**: ✅ **Fully Implemented** - **Recommended for Production**

**Location**: [nginx/](nginx/)

**Endpoints**:

- `https://localhost:8443/` - Standard TLS endpoint
- `https://localhost:8444/` - mTLS required endpoint (strict enforcement)
- `https://localhost:8443/health` - Health check (TLS)
- `https://localhost:8444/health` - Health check (mTLS)

**Quick Start**:

```bash
cd nginx
./start.sh
./curlit.sh
```

**Advantage**: True mTLS enforcement using separate server blocks. Port 8444 **rejects** connections without valid client certificates at the TLS handshake level.

### ✅ 3. Apache APISIX (Complete)

**Link**: <https://apisix.apache.org/>

Cloud-native API Gateway with dynamic routing and plugin system. Built on Nginx and OpenResty.

**Status**: ✅ **Fully Implemented** - Dynamic API configuration, TLS/mTLS working

**Location**: [apisix/](apisix/)

**Endpoints**:

- `https://localhost:9443/` - Standard TLS endpoint
- `https://localhost:9444/` - mTLS required endpoint
- `https://localhost:9443/health` - Health check
- `http://localhost:9180/apisix/admin` - Admin API

**Quick Start**:

```bash
cd apisix
./start.sh
./curlit.sh
```

**Key Feature**: Dynamic configuration via Admin API. Routes configured at runtime with etcd backend.

### ✅ 4. Traefik (Complete)

**Link**: <https://traefik.io/>

Modern HTTP reverse proxy and load balancer. Cloud-native with automatic service discovery.

**Status**: ✅ **Fully Implemented**

**Location**: [traefik/](traefik/)

**Endpoints**:

- `https://localhost:8443/` - Standard TLS endpoint
- `https://localhost:8444/` - mTLS required endpoint
- `https://localhost:8443/health` - Health check
- `http://localhost:8080` - Dashboard

**Quick Start**:

```bash
cd traefik
./start.sh
./curlit.sh
```

**Key Feature**: File-based dynamic configuration with TLS options per router. Built-in dashboard for monitoring.

## Common Prerequisites

All examples require:

1. **Generated CA and Certificates**:

```bash
cd ..
./steps.sh step01                                              # Root CA
./steps.sh step02                                              # Intermediate CA
./build_ca_bundle.sh                                          # CA bundle
./steps.sh step03 localhost                                   # Server certificate
./steps.sh step_tls_client "John TLS Client" john@example.com # TLS client certificate
```

2. **Docker and Docker Compose** installed and running

## Testing

Each example includes a `curlit.sh` script that tests:

- ✅ Standard TLS connections
- ✅ Client certificate authentication
- ✅ Health endpoints
- ✅ Proper error handling

## Comparison

| Feature              | Caddy               | Nginx                | APISIX       | Traefik                     |
| -------------------- | ------------------- | -------------------- | ------------ | --------------------------- |
| **Status**           | ✅ Complete         | ✅ Complete          | ✅ Complete  | ✅ Complete                 |
| **Configuration**    | Simple              | Traditional          | Dynamic API  | YAML/Labels                 |
| **Auto-HTTPS**       | ✅ Yes              | ❌ No                | ❌ No        | ✅ Yes (Let's Encrypt)      |
| **mTLS Enforcement** | ⚠️ Limited (server) | ✅ Excellent (TLS)   | ✅ Per-SSL   | ✅ Per-router (TLS options) |
| **Dashboard**        | ❌ No               | ❌ No (third-party)  | ✅ Admin API | ✅ Built-in                 |
| **Performance**      | High                | Very High            | Very High    | High                        |
| **Best For**         | Simple setups       | **Production Ready** | API Gateway  | Microservices/K8s           |
| **Example Ready**    | ✅ Yes              | ✅ Yes               | ✅ Yes       | ✅ Yes                      |

## Protocol Support

Modern protocol support comparison across all server implementations:

| Protocol      | Caddy                      | Nginx                           | APISIX                   | Traefik                 |
| ------------- | -------------------------- | ------------------------------- | ------------------------ | ----------------------- |
| **HTTP/1.1**  | ✅ Full support            | ✅ Full support                 | ✅ Full support          | ✅ Full support         |
| **HTTP/2**    | ✅ Enabled by default      | ✅ Available (needs `http2 on`) | ✅ Configurable per port | ✅ Auto-enabled         |
| **HTTP/3**    | ✅ Experimental support    | ⚠️ Requires QUIC module         | ⚠️ Experimental (3.x+)   | ⚠️ Experimental (v3.0+) |
| **QUIC**      | ✅ Built-in (experimental) | ⚠️ Separate module required     | ⚠️ Experimental support  | ⚠️ Experimental support |
| **WebSocket** | ✅ Native support          | ✅ Native support               | ✅ Via plugin            | ✅ Native support       |
| **gRPC**      | ✅ Native support          | ✅ Native support               | ✅ Via grpc-transcode    | ✅ Native support       |

### Protocol Configuration in Examples

#### HTTP/2 Support

All examples in this repository have **HTTP/2 enabled**:

- **Caddy**: Enabled automatically when HTTPS is configured

  ```caddyfile
  localhost:8443 {
    # HTTP/2 is automatic
  }
  ```

- **Nginx**: Enabled via `http2` directive in listen statement

  ```nginx
  listen 8443 ssl http2;
  ```

- **APISIX**: Configured at the apisix level

  ```yaml
  apisix:
    enable_http2: true
  ```

- **Traefik**: Automatically enabled for HTTPS

#### HTTP/3 / QUIC Support

**Current Status**: HTTP/3 and QUIC are **NOT enabled** in these examples as they are:

- Still experimental in most servers
- Require UDP port configuration
- Need special compilation/modules in some cases
- Have varying levels of stability

**To Enable HTTP/3** (for advanced users):

<details>
<summary><b>Caddy HTTP/3 Configuration</b></summary>

Add to Caddyfile:

```caddyfile
{
  servers {
    protocols h1 h2 h3
  }
}

localhost:8443 {
  # Your config
}
```

Expose UDP port in docker-compose.yaml:

```yaml
ports:
  - "8443:8443/tcp"
  - "8443:8443/udp" # For QUIC/HTTP3
```

</details>

<details>
<summary><b>Nginx HTTP/3 Configuration</b></summary>

Requires Nginx compiled with `--with-http_v3_module`:

```nginx
listen 8443 ssl http2;
listen 8443 quic reuseport;
http3 on;
add_header Alt-Svc 'h3=":8443"; ma=86400';
```

Note: Standard Nginx packages may not include HTTP/3 support.

</details>

<details>
<summary><b>APISIX HTTP/3 Configuration</b></summary>

Enable in config.yaml:

```yaml
apisix:
  enable_http3: true
  ssl:
    listen:
      - port: 9443
        enable_http3: true
```

Note: Requires APISIX 3.0+ with HTTP/3 support compiled in.

</details>

<details>
<summary><b>Traefik HTTP/3 Configuration</b></summary>

Add to traefik.yml:

```yaml
entryPoints:
  websecure:
    address: ":8443"
    http3:
      advertisedPort: 8443
```

Expose UDP port in docker-compose.yaml:

```yaml
ports:
  - "8443:8443/tcp"
  - "8443:8443/udp"
```

</details>

### WebSocket Support

All servers support WebSocket connections over HTTPS:

- **Caddy**: Automatic WebSocket upgrade detection
- **Nginx**: Requires proxy headers configuration
- **APISIX**: Native support with websocket plugin
- **Traefik**: Automatic WebSocket support

### gRPC Support

All servers can proxy gRPC traffic:

- **Caddy**: Use `reverse_proxy` with `h2c` protocol
- **Nginx**: Use `grpc_pass` directive
- **APISIX**: Use `grpc-transcode` or `grpc-web` plugins
- **Traefik**: Automatic gRPC support with proper configuration

### Performance Considerations

**HTTP/2 Benefits**:

- ✅ Multiplexing (multiple requests over one connection)
- ✅ Header compression (HPACK)
- ✅ Server push capabilities
- ✅ Binary protocol (more efficient parsing)

**HTTP/3 / QUIC Benefits**:

- ✅ Reduced latency (0-RTT connection establishment)
- ✅ Better performance on lossy networks
- ✅ Connection migration (survives IP changes)
- ⚠️ Higher CPU usage (more complex encryption)

**Recommendation**: Stick with **HTTP/2 over TLS** for production use until HTTP/3 becomes more stable and widely adopted.

## Integration with Main Project

All examples:

- Use certificates from `~/.config/demo-cfssl/`
- Share the same CA infrastructure
- Are compatible with CRL and OCSP examples
- Follow the same architectural patterns

## Security Notes

⚠️ **These are demonstration/development setups**

For production:

- Use proper secrets management
- Implement certificate rotation
- Add CRL/OCSP checking
- Enable security headers
- Use HSM for CA keys
- Implement proper monitoring

## Contributing

To add a new server example:

1. Create a new directory following the naming pattern
2. Include all standard files (Dockerfile, docker-compose.yaml, etc.)
3. Add comprehensive README with troubleshooting
4. Update this main README with the new example
5. Test thoroughly before submitting

## License

Same as main project - see [../LICENSE](../LICENSE)
